diff -Nur lmdb-LMDB_0.9.16/libraries/liblmdb/mdb.c lmdb-LMDB_0.9.16n/libraries/liblmdb/mdb.c
--- lmdb-LMDB_0.9.16/libraries/liblmdb/mdb.c	2015-08-14 08:00:38.000000000 +0800
+++ lmdb-LMDB_0.9.16n/libraries/liblmdb/mdb.c	2015-11-12 17:08:30.537190606 +0800
@@ -2646,7 +2646,10 @@
 	MDB_txn *txn;
 	MDB_ntxn *ntxn;
 	int rc, size, tsize = sizeof(MDB_txn);
-
+	if (!env) {
+		DPUTS("environment had fatal error, must shutdown!");
+		return MDB_PANIC;
+	}
 	if (env->me_flags & MDB_FATAL_ERROR) {
 		DPUTS("environment had fatal error, must shutdown!");
 		return MDB_PANIC;
@@ -2871,7 +2874,7 @@
 	if ((txn->mt_flags & MDB_TXN_RDONLY) && txn->mt_u.reader)
 		txn->mt_u.reader->mr_pid = 0;
 
-	if (txn != txn->mt_env->me_txn0)
+	if (txn->mt_env && (txn != txn->mt_env->me_txn0))
 		free(txn);
 }
 
