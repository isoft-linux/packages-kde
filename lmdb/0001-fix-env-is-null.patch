--- a/mdb.c	2014-12-11 16:47:11.000000000 +0800
+++ b/mdb.c	2015-11-09 16:57:17.150572166 +0800
@@ -2605,6 +2605,10 @@
 	MDB_ntxn *ntxn;
 	int rc, size, tsize = sizeof(MDB_txn);
 
+    if (env == NULL) {
+        DPUTS("environment had fatal error, must shutdown!");
+        return MDB_PANIC;
+    }
 	if (env->me_flags & MDB_FATAL_ERROR) {
 		DPUTS("environment had fatal error, must shutdown!");
 		return MDB_PANIC;
@@ -2829,8 +2833,10 @@
 	if ((txn->mt_flags & MDB_TXN_RDONLY) && txn->mt_u.reader)
 		txn->mt_u.reader->mr_pid = 0;
 
-	if (txn != txn->mt_env->me_txn0)
-		free(txn);
+    if (txn->mt_env) {
+	    if (txn != txn->mt_env->me_txn0)
+		    free(txn);
+    }
 }
 
 /** Save the freelist as of this transaction to the freeDB.
